{
  "plan_id": "PLAN-TSK-002",
  "task_category": "predictive",
  "methods_proposed": [
    {
      "method_id": "METHOD-1",
      "name": "Seasonal Moving Average Baseline",
      "description": "Simple moving average baseline using 3-season rolling window to establish baseline performance",
      "implementation_code": "import pandas as pd\nimport numpy as np\nfrom sklearn.metrics import mean_absolute_error\n\n# Load prepared data\ndf = pd.read_parquet('/scratch/ziv_baretto/llmserve/final_code/output/stage3b_data_prep/prepared_PLAN-TSK-002.parquet')\n\n# Define season order for temporal sorting\nseason_order = {'Kharif': 0, 'Rabi': 1, 'Summer': 2, 'Total': 3}\ndf['season_num'] = df['Season'].map(season_order)\ndf = df.sort_values(['Crop', 'season_num'])\n\n# Identify target column dynamically (latest production column)\ntarget_col = 'Production-2024-25'\n\n# Split by season: train on first 3 seasons, validate on 'Total'\ntrain_df = df[df['Season'] != 'Total'].copy()\nval_df = df[df['Season'] == 'Total'].copy()\n\n# Baseline: 3-season moving average per crop\npredictions = []\nfor crop in val_df['Crop'].unique():\n    crop_train = train_df[train_df['Crop'] == crop]\n    if len(crop_train) >= 3:\n        # Use last 3 seasons as moving average\n        ma_value = crop_train[target_col].tail(3).mean()\n    else:\n        # Fallback to overall mean\n        ma_value = crop_train[target_col].mean()\n    predictions.append(ma_value)\n\n# Calculate MAE\nmae = mean_absolute_error(val_df[target_col], predictions)\nprint(f\"Seasonal Moving Average MAE: {mae:.2f}\")\n",
      "libraries_required": [
        "pandas",
        "numpy",
        "scikit-learn"
      ],
      "metric": "MAE"
    },
    {
      "method_id": "METHOD-2",
      "name": "SARIMA Seasonal Model",
      "description": "Seasonal ARIMA model with automatic season period detection (seasonal_period=4 for Kharif/Rabi/Summer/Total)",
      "implementation_code": "import pandas as pd\nimport numpy as np\nfrom statsmodels.tsa.statespace.sarimax import SARIMAX\nfrom sklearn.metrics import mean_squared_error\n\n# Load prepared data\ndf = pd.read_parquet('/scratch/ziv_baretto/llmserve/final_code/output/stage3b_data_prep/prepared_PLAN-TSK-002.parquet')\n\n# Define season order\nseason_order = {'Kharif': 0, 'Rabi': 1, 'Summer': 2, 'Total': 3}\ndf['season_num'] = df['Season'].map(season_order)\ndf = df.sort_values(['Crop', 'season_num'])\n\n# Target column\ntarget_col = 'Production-2024-25'\n\n# Split data\ntrain_df = df[df['Season'] != 'Total'].copy()\nval_df = df[df['Season'] == 'Total'].copy()\n\n# Fit SARIMA per crop\npredictions = []\nfor crop in val_df['Crop'].unique():\n    crop_train = train_df[train_df['Crop'] == crop]\n    if len(crop_train) >= 4:\n        try:\n            # SARIMA(1,0,1)(1,0,1,4) - seasonal period=4\n            model = SARIMAX(\n                crop_train[target_col],\n                order=(1, 0, 1),\n                seasonal_order=(1, 0, 1, 4),\n                enforce_stationarity=False,\n                enforce_invertibility=False\n            )\n            fitted = model.fit(disp=False)\n            forecast = fitted.forecast(steps=1)[0]\n            predictions.append(forecast)\n        except:\n            # Fallback to mean\n            predictions.append(crop_train[target_col].mean())\n    else:\n        predictions.append(crop_train[target_col].mean())\n\n# Calculate RMSE\nrmse = np.sqrt(mean_squared_error(val_df[target_col], predictions))\nprint(f\"SARIMA RMSE: {rmse:.2f}\")\n",
      "libraries_required": [
        "pandas",
        "numpy",
        "statsmodels"
      ],
      "metric": "RMSE"
    },
    {
      "method_id": "METHOD-3",
      "name": "Random Forest with Seasonal Features",
      "description": "Random Forest regression using season encoding and engineered features (Area_rolling_avg_3yr, Yield_yoy_change)",
      "implementation_code": "import pandas as pd\nimport numpy as np\nfrom sklearn.ensemble import RandomForestRegressor\nfrom sklearn.metrics import r2_score\nfrom sklearn.preprocessing import LabelEncoder\n\n# Load prepared data\ndf = pd.read_parquet('/scratch/ziv_baretto/llmserve/final_code/output/stage3b_data_prep/prepared_PLAN-TSK-002.parquet')\n\n# Define season order\nseason_order = {'Kharif': 0, 'Rabi': 1, 'Summer': 2, 'Total': 3}\ndf['season_num'] = df['Season'].map(season_order)\n\n# Encode crop as categorical\nle = LabelEncoder()\ndf['crop_encoded'] = le.fit_transform(df['Crop'])\n\n# Target column\ntarget_col = 'Production-2024-25'\n\n# Features: season_num, crop_encoded, Area_rolling_avg_3yr, Yield_yoy_change, + recent area/production\nfeature_cols = [\n    'season_num', 'crop_encoded',\n    'Area_rolling_avg_3yr', 'Yield_yoy_change',\n    'Area-2023-24', 'Production-2023-24', 'Yield-2023-24'\n]\n\n# Split data\ntrain_df = df[df['Season'] != 'Total'].copy()\nval_df = df[df['Season'] == 'Total'].copy()\n\nX_train = train_df[feature_cols]\ny_train = train_df[target_col]\nX_val = val_df[feature_cols]\ny_val = val_df[target_col]\n\n# Train Random Forest\nrf = RandomForestRegressor(n_estimators=100, max_depth=10, random_state=42)\nrf.fit(X_train, y_train)\n\n# Predict\npredictions = rf.predict(X_val)\n\n# Calculate R\u00b2\nr2 = r2_score(y_val, predictions)\nprint(f\"Random Forest R\u00b2: {r2:.4f}\")\n",
      "libraries_required": [
        "pandas",
        "numpy",
        "scikit-learn"
      ],
      "metric": "R2"
    }
  ],
  "data_split_strategy": "Train on first 3 seasons (Kharif, Rabi, Summer), validate on Total season. This represents an 80/20 split by season order for crop-wise predictions.",
  "date_column": "Season",
  "target_column": "Production-2024-25",
  "train_period": "Kharif, Rabi, Summer seasons",
  "validation_period": "Total season",
  "test_period": null,
  "data_preprocessing_steps": [
    "Load prepared_PLAN-TSK-002.parquet from Stage 3B output directory",
    "Verify target column 'Production-2024-25' exists and has no nulls",
    "Map 'Season' to numerical order: Kharif=0, Rabi=1, Summer=2, Total=3",
    "Sort data by Crop and season_num for temporal consistency",
    "Split: train = Kharif/Rabi/Summer, validation = Total",
    "For ML methods: Encode 'Crop' as numerical categories",
    "For ML methods: Include engineered features (Area_rolling_avg_3yr, Yield_yoy_change)",
    "Ensure all features are numeric and have no missing values"
  ],
  "created_at": "2025-12-01T22:21:11.057655",
  "created_by": "extraction_script_round7"
}